import pefile 
import os.path
import tkinter as tk
from tkinter import *
from tkinter.filedialog import askopenfilename
import pandas as pd
import numpy as np
import keras


def get_api_list():
    API_list=[]
    file=pefile.PE(filepath)
    for entry in file.DIRECTORY_ENTRY_IMPORT:
        for API in entry.imports:
            API_list.append(API.name)
    API_list=[i.decode() for i in API_list]
    return API_list

def get_input():
    API_list=get_api_list()
    df=pd.read_csv("dataset.csv")
    cols=df.columns.tolist()[1:]
    col_dict={}
    for i in range(len(cols)):
        col_dict[cols[i].lower()]=i
    input_data=np.zeros((1,1000)).astype('int32')
    for API in API_list:
        if API in col_dict.keys():
            input_data[0][col_dict[API.lower()]]=1
    return input_data

def CheckForMalware():
	global filepath
	global index

	filename=filepath.split("/")[-1]
	input_data=get_input()
	model = keras.models.load_model("models/model_1")
	x = model.predict(input_data)
	if x<0.5:
		mylist.insert(index,"Uploaded " + filename + "  executable might not be malware!!")
	else:
		mylist.insert(index,"Uploaded " + filename + "  executable might be a malware!!")
	index+=1
	button1['state']=NORMAL
	button2['state']=DISABLED

def AskForExec():
  
    global filepath
    global index

    filepath=askopenfilename()
    text=""
    filename=filepath.split("/")[-1]
    if len(filepath) == 0 or filename.split(".")[1] != "exe":
        text="File {} is not an executable,try uploading again!!".format(filename)
    else:
        text="File {} uploaded successfully!".format(filename)
        button2['state']=NORMAL
        button1['state']=DISABLED
    mylist.insert(index,text)
    index+=1
    


def DeleteOutput():
	global mylist
	mylist.delete(0,END)

def main():
	global mylist
	global button1
	global button2
	global index

	index=1

	m = tk.Tk()
	m.geometry("500x300") 
	m.title("Malware Analysis")

	frame=Frame(m)
	frame.pack()
	button1 = tk.Button(frame, text = "Upload Windows Executable", width = 30, command = AskForExec)
	button1.pack(side=TOP)
	button2=tk.Button(frame,text= "Check for Malware/Goodware",width=30,command=CheckForMalware)
	button2.pack(side=TOP)
	button2['state']=DISABLED
	mylist=Listbox(frame,width=80)
	mylist.pack(side=TOP)
	button3=tk.Button(frame,text="Clear output",width=30,command=DeleteOutput)
	button3.pack(side=TOP)
	m.mainloop()

if __name__=="__main__":
	main()

