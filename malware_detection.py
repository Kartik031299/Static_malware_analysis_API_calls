import pefile 
import os.path
import tkinter as tk
from tkinter import *
from tkinter.filedialog import askopenfilename
import pandas as pd
import numpy as np
import keras

filepath=""

def get_api_list():
    API_list=[]
    file=pefile.PE(filepath)
    for entry in file.DIRECTORY_ENTRY_IMPORT:
        for API in entry.imports:
            API_list.append(API.name)
    API_list=[i.decode() for i in API_list]
    return API_list

def get_input():
    API_list=get_api_list()
    df=pd.read_csv("dataset.csv")
    cols=df.columns.tolist()[1:]
    col_dict={}
    for i in range(len(cols)):
        col_dict[cols[i].lower()]=i
    input_data=np.zeros((1,1000)).astype('int32')
    for API in API_list:
        if API in col_dict.keys():
            input_data[0][col_dict[API.lower()]]=1
    return input_data

def CheckForMalware():
	input_data=get_input()
	model = keras.models.load_model("models/model_1")
	x = model.predict(input_data)
	if x<0.5:
		l1=tk.Label(m,text="Uploaded executable might \n not be malware!!",wraplength=400,justify="center")
		l1.pack()
	else:
		l1=tk.Label(m,text="Uploaded Executable might \n be a malware!!",wraplength=400,justify="center")
		l1.pack()


def AskForExec():
    
    _list = m.winfo_children()
    for item in _list:
        item.pack_forget()
    global filepath
    filepath=askopenfilename()
    l1=tk.Label(m,text="File uploaded successfully!",wraplength=400,justify="center")
    l1.pack()
    button2=tk.Button(m,text="Check for Malware/Goodware",width = 30,command=CheckForMalware)
    button2.pack()

m = tk.Tk()
m.geometry("300x200") 
m.title("Malware Analysis")


button1 = tk.Button(m, text = "Upload Windows Executable", width = 30, command = AskForExec)
button1.pack()

m.mainloop()

